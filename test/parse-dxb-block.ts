import type { StructureDefinition } from "../types.ts";
import dxbStructureDef from "../examples/dxb.json" with { type: "json" };
import { parseAndPackStructure } from "../packer.ts";
import { assertEquals } from "@std/assert/equals";

Deno.test("structure", () => {
    const dxb = Deno.readFileSync(new URL("./test-block.dxb", import.meta.url));
    const packed = parseAndPackStructure(
        dxbStructureDef as StructureDefinition,
        dxb,
    );
    const expectedPacked = {
        routing_header: {
            version: 1,
            block_size: 1113,
            flags: {
                signature_type: "None",
                encryption_type: "None",
                receiver_type: "ReceiversWithKeys",
                is_bounce_back: false,
                has_checksum: false,
            },
            checksum: null,
            distance: 0,
            ttl: 42,
            sender: "@@local",
            receivers_pointer_id: null,
            number_of_receivers: 2,
            receivers: null,
            receivers_with_keys: [
                {
                    receiver: "@jonas",
                    key: "0101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101",
                },
                {
                    receiver: "@ben",
                    key: "0202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202",
                },
            ],
            signature: null,
            encrypted_signature: null,
        },
        block_header: {
            context_id: 0,
            section_index: 0,
            block_number: 43,
            flags_and_timestamp: {
                block_type: "TraceBack",
                has_side_effects: true,
                has_only_data: true,
                is_end_of_section: true,
                is_end_of_context: true,
                has_lifetime: false,
                has_represented_by: false,
                has_iv: false,
                is_compressed: false,
                is_signature_in_last_subblock: false,
                creation_timestamp: 0,
            },
            lifetime: null,
            represented_by: null,
            iv: null,
        },
        encrypted_header: {
            flags: { user_agent: "Unknown", has_on_behalf_of: false },
            on_behalf_of: null,
        },
        body: {},
    };
    assertEquals(packed, expectedPacked);
});
